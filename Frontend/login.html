<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PizzaHub OAuth Login</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f2f2f2;
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .login-card {
            background-color: white;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
            text-align: center;
            padding: 40px 30px;
            width: 320px;
            display: flex;
            flex-direction: column;
            align-items: center;
            transition: transform 0.3s ease;
        }

        .login-card:hover {
            transform: translateY(-10px);
        }

        h2 {
            color: #E60023;
            margin-bottom: 15px;
            font-size: 24px;
        }

        .logo {
            align-items: center;
            justify-content: center;
            width: 120px;
            margin-bottom: 20px;
        }

        p {
            color: #555;
            margin-bottom: 25px;
            font-size: 16px;
        }

        .login-button {
            background-color: #E60023;
            color: white;
            border: none;
            border-radius: 25px;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.3s;
        }

        .login-button:hover {
            background-color: #C0001A;
            transform: scale(1.05);
        }
    </style>
</head>

<body>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <div class="login-card">
        <h2>Welcome to PizzaHub</h2>
        <img src="/images/pizza_logo.png" alt="PizzaHub Logo" class="logo">
        <p>Login for Fresh, Hot, and Delicious</p>

        <div id="g_id_onload" data-client_id="477896352233-42j7dt9ure6epjnlmcaj8dtlesjupamr.apps.googleusercontent.com"
            data-callback="handleCredentialResponse">
        </div>
        <div class="g_id_signin" data-type="standard"></div>
    </div>

    <script>
        async function handleCredentialResponse(response) {
            const token = response.credential;
            console.log('Token:', token);

            // Save the token to localStorage
            localStorage.setItem('authToken', token);
            localStorage.setItem('paymentId', 1);
            localStorage.setItem('userId', 1);
            // Manually decode the JWT token
            const decodeJwtPayload = (token) => {
                const base64Url = token.split('.')[1];
                const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                const jsonPayload = decodeURIComponent(atob(base64).split('').map(function (c) {
                    return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                }).join(''));

                return JSON.parse(jsonPayload);
            };

            const decodedToken = decodeJwtPayload(token);
            console.log(decodedToken);



            try {


                // Fetch user role using the email (if needed)
                const userEmail = decodedToken.email; // Adjust this to match the actual claim for the email in your token
                localStorage.setItem('email', userEmail);
                let roleResponse = await fetch(`https://localhost:7028/api/User/GetUserRole?email=${encodeURIComponent(userEmail)}`);
                if (!roleResponse.ok) {
                    let errorText = await roleResponse.text();
                    throw new Error(`Failed to get user role: ${errorText}`);
                }

                let userRole = await roleResponse.json();
                console.log('User Role:', userRole);

                if (userRole === 0) {
                    window.location.href = 'admin.html';
                } else {
                    window.location.href = 'index.html';
                }

            } catch (error) {
                console.error('Error:', error);
            }
        }
    
    </script>
</body>

</html>